package summary

import (
	"context"
	"fmt"
	"time"

	"bot/pkg/logger"

	"google.golang.org/genai"
)

// Package logger
var log = logger.Package("summary")

type Summarizer struct {
	client *genai.Client
}

type Config struct {
	APIKey string
}

// Models in order of preference
var modelPriority = []string{
	"gemini-2.5-flash-lite",
	"gemini-2.0-flash-lite",
	"gemini-2.0-flash",
	"gemini-1.5-flash-8b",
}

// New creates a new instance of Summarizer
func New(cfg Config) (*Summarizer, error) {
	ctxLog := log.WithContext("method", "New")

	ctx := context.Background()
	ctxLog.Info("Creating Gemini client")
	client, err := genai.NewClient(ctx, &genai.ClientConfig{
		APIKey:  cfg.APIKey,
		Backend: genai.BackendGeminiAPI,
	})
	if err != nil {
		ctxLog.Error("Error creating Gemini client", "error", err)
		return nil, fmt.Errorf("error creating Gemini client: %w", err)
	}

	ctxLog.Info("Summarizer initialized successfully")
	return &Summarizer{
		client: client,
	}, nil
}

// Close closes the Gemini client
func (s *Summarizer) Close() {
	ctxLog := log.WithContext("method", "Close")
	ctxLog.Info("Gemini client cleanup (no action needed)")
}

// GenerateSummary generates a summary for the given PDF file
// with fallback to alternative models if the primary model fails
func (s *Summarizer) GenerateSummary(ctx context.Context, pdfPath string) (string, error) {
	ctxLog := log.WithRequestContext(ctx).
		WithContext("method", "GenerateSummary").
		WithContext("pdfPath", pdfPath)

	ctxLog.Debug("Uploading file to Gemini")
	fileURI, err := s.uploadFile(ctx, pdfPath, "application/pdf")
	if err != nil {
		ctxLog.Error("Error uploading file", "error", err)
		return "", fmt.Errorf("error uploading file: %w", err)
	}
	ctxLog.Debug("File uploaded successfully", "fileURI", fileURI)

	// Try each model in order of priority
	var lastError error
	for _, modelName := range modelPriority {
		ctxLog.Debug("Attempting to generate summary", "model", modelName)
		summary, err := s.tryGenerateSummaryWithModel(ctx, modelName, fileURI)
		if err == nil {
			// Success with this model
			ctxLog.Info("AI summary generated successfully", "model", modelName, "length", len(summary))
			return summary, nil
		}

		lastError = err
		ctxLog.Warn("Failed to generate summary with model", "model", modelName, "error", err)

		// Add a small delay before trying the next model
		time.Sleep(500 * time.Millisecond)
	}

	ctxLog.Error("All models failed to generate summary", "lastError", lastError)
	return "", fmt.Errorf("all models failed to generate summary, last error: %w", lastError)
}

// tryGenerateSummaryWithModel attempts to generate a summary with the specified model
func (s *Summarizer) tryGenerateSummaryWithModel(ctx context.Context, modelName string, fileURI string) (string, error) {
	ctxLog := log.WithRequestContext(ctx).
		WithContext("method", "tryGenerateSummaryWithModel").
		WithContext("model", modelName)

	ctxLog.Debug("Creating model config")
	config := createModelConfig()

	ctxLog.Debug("Creating chat session with file")
	// Create history with the uploaded file
	history := []*genai.Content{
		genai.NewContentFromURI(fileURI, "application/pdf", genai.RoleUser),
	}

	chat, err := s.client.Chats.Create(ctx, modelName, config, history)
	if err != nil {
		ctxLog.Error("Error creating chat session", "error", err)
		return "", fmt.Errorf("error creating chat session with model %s: %w", modelName, err)
	}

	ctxLog.Debug("Sending message to model")
	resp, err := chat.Send(ctx, genai.NewPartFromText("Please provide a summary of this document"))
	if err != nil {
		ctxLog.Error("Error generating summary", "error", err)
		return "", fmt.Errorf("error generating summary with model %s: %w", modelName, err)
	}

	if len(resp.Candidates) == 0 || len(resp.Candidates[0].Content.Parts) == 0 {
		ctxLog.Error("No summary generated", "candidates", len(resp.Candidates))
		return "", fmt.Errorf("no summary generated by model %s", modelName)
	}

	// Extract text from the response
	part := resp.Candidates[0].Content.Parts[0]
	if part.Text != "" {
		return part.Text, nil
	}

	return fmt.Sprintf("%v", part), nil
}

// uploadFile uploads a file to Gemini and returns its URI
func (s *Summarizer) uploadFile(ctx context.Context, path, mimeType string) (string, error) {
	ctxLog := log.WithRequestContext(ctx).
		WithContext("method", "uploadFile").
		WithContext("path", path).
		WithContext("mimeType", mimeType)

	ctxLog.Debug("Uploading file to Gemini")
	fileData, err := s.client.Files.UploadFromPath(ctx, path, &genai.UploadFileConfig{
		DisplayName: path,
		MIMEType:    mimeType,
	})
	if err != nil {
		ctxLog.Error("Error uploading file", "error", err)
		return "", fmt.Errorf("error uploading file: %w", err)
	}

	return fileData.URI, nil
}

// createModelConfig creates the Gemini model configuration with optimal settings
func createModelConfig() *genai.GenerateContentConfig {
	temperature := float32(0.7)
	topK := float32(64)
	topP := float32(0.95)
	maxTokens := int32(8192)

	systemInstruction := "You are a concise and focused assistant. Based on the attached document, generate a 40-50 word summary emphasizing specific actions or decisions, such as penalties issued, rule changes, or instances where no action was taken, but only when there was some incident and it specifically mentions no penalty given. Prioritize clarity and relevance to highlight key outcomes. Provide only the summary without any additional explanation or commentary."

	return &genai.GenerateContentConfig{
		SystemInstruction: genai.NewContentFromText(systemInstruction, genai.RoleUser),
		Temperature:       &temperature,
		TopK:              &topK,
		TopP:              &topP,
		MaxOutputTokens:   maxTokens,
	}
}
